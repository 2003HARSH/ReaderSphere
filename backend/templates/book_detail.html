{% extends "base.html" %}

{% block title %}Book Details{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="card mb-4 shadow-sm">
    <div class="row g-0">
      <div class="col-md-4 text-center">
        <img src="{{ Thumbnail }}" alt="{{ Title }}" class="img-fluid rounded-start p-3" style="max-height: 400px;">
      </div>
      <div class="col-md-8">
        <div class="card-body">
          <h3 class="card-title">{{ Title }}</h3>
          <p><strong>Authors:</strong> {{ Authors | join(', ') if Authors else 'Unknown' }}</p>
          <p><strong>Publisher:</strong> {{ Publisher or 'N/A' }}</p>
          <p><strong>Categories:</strong> {{ Category | join(', ') if Category else 'N/A' }}</p>
          <p><strong>Page Count:</strong> {{ pageCount or 'N/A' }}</p>
        </div>
          
          <hr>
          
          <!-- Rating Display Section -->
          <h5>Community Rating</h5>
          <div class="d-flex align-items-center mb-3">
              <div id="average-rating-stars" class="star-rating me-2">
                  <!-- Stars are generated by JavaScript -->
              </div>
              <span id="average-rating-text" class="fw-bold">{{ avg_rating }}</span>
              <span id="rating-count-text" class="text-muted ms-1">({{ rating_count }} ratings)</span>
          </div>

          <!-- User Rating Section -->
          <h5>Your Rating</h5>
          <div id="user-rating-stars" class="star-rating interactive" data-book-id="{{ book_id }}">
              {% for i in range(1, 6) %}
                  <span class="star" data-value="{{ i }}">&#9733;</span>
              {% endfor %}
          </div>
          <small id="rating-message" class="form-text text-success mt-1"></small>
          
          <hr>

          <p class="card-text"><strong>Description:</strong></p>
          <p>{{ Description or 'No description available.' }}</p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
    .star-rating {
        font-size: 2rem;
        color: #d3d3d3; /* Light grey for empty stars */
    }
    .star-rating .star {
        transition: color 0.2s;
    }
    .star-rating.interactive .star {
        cursor: pointer;
    }
    /* Gold color for filled/selected stars */
    .star-rating .star.selected,
    .star-rating .star.filled {
        color: #ffc107; 
    }
    /* Hover effect for interactive stars */
    .star-rating.interactive:hover .star {
        color: #ffc107;
    }
    .star-rating.interactive .star:hover ~ .star {
        color: #d3d3d3;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const userRatingContainer = document.getElementById('user-rating-stars');
        const stars = userRatingContainer.querySelectorAll('.star');
        const bookId = userRatingContainer.dataset.bookId;
        const ratingMessage = document.getElementById('rating-message');
        let initialUserRating = {{ user_rating | default(0) }};

        // Function to visually set the user's star rating
        function setUserRating(rating) {
            stars.forEach(star => {
                star.classList.toggle('selected', star.dataset.value <= rating);
            });
        }

        // Function to display the average star rating
        function displayAverageRating() {
            const avgRatingContainer = document.getElementById('average-rating-stars');
            const avgRatingText = document.getElementById('average-rating-text').textContent;
            const avgRating = (avgRatingText === "Not yet rated") ? 0 : parseFloat(avgRatingText);
            
            let avgHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= avgRating) {
                    avgHtml += '<span class="star filled">&#9733;</span>'; // Full star
                } else {
                    avgHtml += '<span class="star">&#9733;</span>'; // Empty star
                }
            }
            avgRatingContainer.innerHTML = avgHtml;
        }

        // Set initial state on page load
        setUserRating(initialUserRating);
        displayAverageRating();

        // Add mouseover event to show hover state
        userRatingContainer.addEventListener('mouseover', function(e) {
            if (e.target.classList.contains('star')) {
                const hoverValue = parseInt(e.target.dataset.value, 10);
                stars.forEach(star => {
                    star.style.color = star.dataset.value <= hoverValue ? '#ffc107' : '#d3d3d3';
                });
            }
        });

        // Add mouseout event to restore the saved rating after a hover
        userRatingContainer.addEventListener('mouseout', () => {
            stars.forEach(star => star.style.color = ''); // Reset inline style
            setUserRating(initialUserRating)
        });
        
        // Add click event to submit the rating
        userRatingContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('star')) {
                const ratingValue = parseInt(e.target.dataset.value, 10);
                initialUserRating = ratingValue; // Update the saved rating immediately
                setUserRating(ratingValue); // Visually lock the new rating

                fetch(`/rate_book/${bookId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating: ratingValue }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        ratingMessage.textContent = 'Your rating has been saved!';
                        // Update average rating display on the page
                        document.getElementById('average-rating-text').textContent = data.new_average;
                        // You could also update the rating count if you passed it back
                        displayAverageRating(); // Redraw the average stars
                    } else {
                        ratingMessage.textContent = data.message || 'An error occurred.';
                        ratingMessage.classList.remove('text-success');
                        ratingMessage.classList.add('text-danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    ratingMessage.textContent = 'Failed to submit rating.';
                });
            }
        });
    });
</script>
{% endblock %}
