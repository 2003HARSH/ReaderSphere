{% extends 'base.html' %}

{% block title %}Groups{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Left Section: Group Management and List -->
        <div class="col-md-4">
            <!-- Create Group Card -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5>Create a New Group</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="group-name" class="form-label">Group Name</label>
                        <input type="text" id="group-name" class="form-control" placeholder="Enter a name for your group">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Add Members (from your friends)</label>
                        <div id="group-members-list" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            {% for friend in user.friends %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="group-members" value="{{ friend.id }}" id="friend-{{ friend.id }}">
                                <label class="form-check-label" for="friend-{{ friend.id }}">
                                    {{ friend.first_name }} (@{{ friend.username }})
                                </label>
                            </div>
                            {% else %}
                            <p class="text-muted small">You have no friends to add to a group.</p>
                            {% endfor %}
                        </div>
                    </div>
                    <button class="btn btn-primary w-100" onclick="createGroup()">Create Group</button>
                </div>
            </div>

            <!-- My Groups List -->
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5>My Groups</h5>
                </div>
                <ul class="list-group list-group-flush" id="group-list">
                    {% for group in user.groups %}
                    <li id="group-{{ group.id }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span onclick="joinGroup('{{ group.id }}', '{{ group.name }}')" style="flex-grow: 1; cursor: pointer;">
                            {{ group.name }}
                        </span>
                        {% if group.created_by_id == user.id %}
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteGroup('{{ group.id }}')">
                            &times;
                        </button>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Right Section: Chat -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 id="chat-group-name">Select a group to start chatting</h5>
                </div>
                <div id="chat-box" class="card-body" style="height: 500px; overflow-y: scroll;">
                    <div id="messages" class="d-flex flex-column">
                        <!-- Messages will be dynamically added here -->
                    </div>
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMessage()" disabled>
                        <button class="btn btn-success" onclick="sendMessage()" disabled>Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
<script>
    const socket = io();
    let currentGroupId = null;
    const currentUserId = `{{ user.id }}`;

    function createGroup() {
        const groupName = document.getElementById('group-name').value.trim();
        const selectedMembers = Array.from(document.querySelectorAll('input[name="group-members"]:checked')).map(checkbox => checkbox.value);

        if (groupName) {
            socket.emit('create_group', { 
                name: groupName,
                members: selectedMembers
            });
        } else {
            alert("Please provide a group name.");
        }
    }

    socket.on('group_created', data => {
        const groupList = document.getElementById('group-list');
        const newItem = document.createElement('li');
        newItem.id = `group-${data.id}`;
        newItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        
        const groupNameSpan = document.createElement('span');
        groupNameSpan.textContent = data.name;
        groupNameSpan.style.flexGrow = 1;
        groupNameSpan.style.cursor = 'pointer';
        groupNameSpan.onclick = () => joinGroup(data.id, data.name);

        const deleteButton = document.createElement('button');
        deleteButton.className = 'btn btn-danger btn-sm';
        deleteButton.innerHTML = '&times;';
        deleteButton.onclick = (e) => {
            e.stopPropagation();
            deleteGroup(data.id);
        };
        
        newItem.appendChild(groupNameSpan);
        // Only the creator gets the delete button on a new group
        if ("{{ user.id }}" == data.creator_id) {
             newItem.appendChild(deleteButton);
        }

        groupList.appendChild(newItem);
        
        // Clear the form
        document.getElementById('group-name').value = '';
        document.querySelectorAll('input[name="group-members"]:checked').forEach(checkbox => checkbox.checked = false);
    });

    function joinGroup(groupId, groupName) {
        currentGroupId = groupId;
        document.getElementById('chat-group-name').textContent = `Chatting in: ${groupName}`;
        document.getElementById('messages').innerHTML = '';
        document.getElementById('message-input').disabled = false;
        document.querySelector('.card-footer button').disabled = false;
        socket.emit('join_group', { group_id: groupId });
    }

    function deleteGroup(groupId) {
        if (confirm('Are you sure you want to permanently delete this group?')) {
            socket.emit('delete_group', { group_id: groupId });
        }
    }

    socket.on('group_deleted', data => {
        const groupElement = document.getElementById(`group-${data.group_id}`);
        if (groupElement) {
            groupElement.remove();
        }
        if (currentGroupId == data.group_id) {
            document.getElementById('chat-group-name').textContent = 'Select a group to start chatting';
            document.getElementById('messages').innerHTML = '';
            document.getElementById('message-input').disabled = true;
            document.querySelector('.card-footer button').disabled = true;
            currentGroupId = null;
        }
    });

    socket.on('group_messages', data => {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        data.messages.forEach(msg => {
            appendMessage(msg.sender, msg.content, msg.sender_id);
        });
        scrollToBottom();
    });

    socket.on('new_group_message', data => {
        if (data.group_id === currentGroupId) {
            appendMessage(data.sender, data.content, data.sender_id);
            scrollToBottom();
        }
    });
    
    function appendMessage(sender, content, senderId) {
        const messagesDiv = document.getElementById('messages');
        const p = document.createElement('p');
        p.innerHTML = `<strong>${sender}:</strong> ${content}`;
        
        const messageClass = (senderId == currentUserId) ? 'align-self-end bg-primary text-white' : 'align-self-start bg-light';
        p.className = `p-2 rounded mb-2 ${messageClass}`;
        messagesDiv.appendChild(p);
    }

    function sendMessage() {
        const content = document.getElementById('message-input').value.trim();
        if (content && currentGroupId) {
            socket.emit('send_group_message', { group_id: currentGroupId, content: content });
            document.getElementById('message-input').value = '';
        }
    }
    
    function scrollToBottom() {
        const chatBox = document.getElementById('chat-box');
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
<style>
    .list-group-item-action {
        cursor: pointer;
    }
</style>
{% endblock %}
